<div id='map' class="w-full h-[80vh] min-h-[400px] rounded-lg shadow-lg"></div>

<script>
  const API_URL = '/api/v1/map_data';
  const UPDATE_INTERVAL = 30000; // 30秒ごとに更新
  let map; // Google Map オブジェクト
  let markers = {}; // マーカーを屋台IDごとに保存するオブジェクト { stallId: { marker, infoWindow } }

  // --- 1. 地図の初期化 (Google Maps API が呼び出すコールバック関数) ---
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 34.8394, lng: 134.6939 }, // {緯度, 経度} (姫路駅周辺)
      zoom: 13, // ズームレベル
    });

    // --- 3. 実行 ---
    // ページ読み込み時にまず1回実行
    updateMapMarkers();
    
    // その後、一定間隔で繰り返し実行
    setInterval(updateMapMarkers, UPDATE_INTERVAL);
  }

  // --- 2. APIからデータを取得してマーカーを更新する関数 ---
  async function updateMapMarkers() {
    console.log('Fetching map data...');
    try {
      const response = await fetch(API_URL);
      if (!response.ok) {
        console.error('Failed to fetch map data');
        return;
      }
      
      const stalls = await response.json();
      
      // 取得したデータでマーカーを更新
      stalls.forEach(stall => {
        // (データが null や undefined の場合は NaN になります)
        const latStr = stall.latitude;
        const lngStr = stall.longitude;
        const latNum = parseFloat(latStr);
        const lngNum = parseFloat(lngStr);

        // (Number.isNaN は、本当に NaN である場合のみ true を返します)
        if (latStr != null && lngStr != null && !Number.isNaN(latNum) && !Number.isNaN(lngNum)) {
          
          const stallId = stall.id;
          // Google Maps は {lat: 緯度, lng: 経度} オブジェクトを使う
          // APIから渡される値は文字列になっている可能性があるため、parseFloatで数値に変換する
          const position = { lat: parseFloat(stall.latitude), lng: parseFloat(stall.longitude) };

          // InfoWindow（マーカークリックで表示）の中身
          const infoWindowContent = `
            <strong>${stall.name}</strong><br>
            状況: ${stall.status || '不明'}<br>
            最終更新: ${new Date(stall.last_updated).toLocaleTimeString()}
          `;

          if (markers[stallId]) {
            // (A) マーカーが既に存在する場合: 位置とInfoWindowとアイコンを更新
            markers[stallId].marker.setPosition(position);
            markers[stallId].infoWindow.setContent(infoWindowContent);
            if (stall.icon_url) {
              markers[stallId].marker.setIcon({
                url: stall.icon_url,
                scaledSize: new google.maps.Size(40, 40)
              });
            } else {
              markers[stallId].marker.setIcon(null); // アイコンが削除された場合はデフォルトに戻す
            }
            
          } else {
            // (B) マーカーがまだない場合: 新しく作成
            const infoWindow = new google.maps.InfoWindow({
              content: infoWindowContent
            });

            const markerOptions = {
              position: position,
              map: map, // マーカーを地図に追加
              title: stall.name
            };

            if (stall.icon_url) {
              markerOptions.icon = {
                url: stall.icon_url,
                scaledSize: new google.maps.Size(40, 40) // アイコンのサイズを40x40に設定
              };
            }

            const marker = new google.maps.Marker(markerOptions);

            // マーカークリックで InfoWindow を開く
            marker.addListener('click', () => {
              infoWindow.open({
                anchor: marker,
                map: map,
              });
            });

            // 作成したマーカーとInfoWindowを保存
            markers[stallId] = { marker: marker, infoWindow: infoWindow };
          }
        } else {
            // 位置情報が不正なデータが来た場合のログ
            console.warn(`Skipping stall ${stall.id} due to invalid location data:`, stall.latitude, stall.longitude);
        }
      });

      console.log('Map updated.');

    } catch (error) {
      console.error('Error updating map:', error);
    }
  }

  // グローバルスコープに関数を公開（コールバックのため）
  window.initMap = initMap;
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>
